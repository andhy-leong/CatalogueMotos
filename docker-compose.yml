version: "3.8"

services:
  cassandra-db:
    image: cassandra:latest
    container_name: cassandra-container
    ports:
      - "9042:9042"
    environment:
      - CASSANDRA_USER=admin
      - CASSANDRA_PASSWORD=admin
    healthcheck:
      test:
        [
          "CMD",
          "cqlsh",
          "-u",
          "admin",
          "-p",
          "admin",
          "-e",
          "describe keyspaces",
        ]
      interval: 15s
      timeout: 10s
      retries: 10
  cassandra-init:
    image: cassandra:latest
    depends_on:
      cassandra-db:
        condition: service_healthy
    volumes:
      - ./backend/schema.cql:/docker-entrypoint-initdb.d/schema.cql
      - ./backend/schema.cql:/schema.cql
    command: >
      bash -c "cqlsh cassandra-db -u admin -p admin -f /schema.cql"

  neo4j-db:
    image: neo4j:latest
    container_name: neo4j-container
    ports:
      - "7474:7474" # C'est l'interface web de neo4j
      - "7687:7687" # Port bolt pour la connexion driver
    environment:
      - NEO4J_AUTH=neo4j/neo4jpassword
    volumes:
      - ./neo4j/data:/data

  backend-api:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: backend-api-container
    ports:
      - "3001:3000"
    environment:
      - CASSANDRA_HOST=cassandra-db
      - CASSANDRA_USER=admin
      - CASSANDRA_PASSWORD=admin
      #Ajout pour neo4j
      - NEO4J_HOST=neo4j-db
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=neo4jpassword
    depends_on:
      cassandra-init:
        condition: service_started

  backend-import:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: backend-import-container
    environment:
      - CASSANDRA_HOST=cassandra-db
      - CASSANDRA_USER=admin
      - CASSANDRA_PASSWORD=admin
    depends_on:
      backend-api:
        condition: service_started
    command: ["npm", "run", "import-data"]
    restart: "no"

  frontend-web:
    image: nginx:latest
    container_name: frontend-web-container
    ports:
      - "80:80"
    # CORRECTION : On utilise "volumes" pour lier les fichiers statiques
    # On supprime la section "build:" qui Ã©tait incorrecte
    volumes:
      - ./frontend:/usr/share/nginx/html
    depends_on:
      backend-api:
        condition: service_started
